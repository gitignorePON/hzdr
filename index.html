<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
    <title>HZDR</title>
  </head>
  <body>
    <h1>Официальный сайт СЗДР</h1>
    <p></p>
    <div class="container-info">
      <h3>Основная информация</h3>
      <p>
        СЗДР - Священные Зевсо-Дюдюкские Республики, союз стран которые решили
        объеденится для большей мощи, в нее входят такие гиганты как СССД,
        Зевсония и еще страны как Быбрия, Никития и т.д.. У каждой страны своя
        культура, язык и интересы. Больше вы можете узнать
        <a href="https://t.me/+EdZIgBkRhK9kNGRi">тут</a>
      </p>
    </div>
    <div class="container-location">
      <h3>Расположение</h3>
      <p>Значительная часть страны находиться на материке "Скулия"</p>
      <div class="iframe-wrapper">
        <iframe
          src="https://yandex.ru/map-widget/v1/?um=constructor%3A9660a029f64c57c27ffe5f6671bdcec7cb6e9efc1e038cf89525129f397e85e9&amp;source=constructor"
          width="100%"
          height="450"
          frameborder="0"
        ></iframe>
      </div>
    </div>
    <div class="container-news">
      <h3>Новости</h3>
      <p>
        Все новости и трэш страны публикуется в телеграмм канале, а на сайте
        будет видно последний пост в конце
      </p>
      <a href="https://t.me/+EdZIgBkRhK9kNGRi" class="neon-button"
        >Телеграмм-канал</a
      >
    </div>
    <div class="container-history">
      <h3>История</h3>
      <p>
        Мы уже писали свой учебник про историю создания СССД
        <a href="https://t.me/c/2441385092/10">"Посмотреть"</a> (только для
        подписчиков канала), и скоро возможно мы будем делать новый учебник,
        чтобы проголосовать за создание нового учебника, можете проголосовать в
        боте: <a href="https://t.me/hzdr1bot">Телеграмм-бот</a>
      </p>
    </div>
    <footer
      style="
        text-align: center;
        padding: 16px;
        margin-top: 40px;
        color: #a0a0d0;
        font-size: 0.9rem;
        border-top: 1px solid rgba(57, 255, 20, 0.1);
      "
    >
      HZDR 2025© Copyright - Страна Имба
    </footer>
    <script>
      const updateLatestPost = async () => {
        const container = document.getElementById("latest-post-content");
        const timeEl = document.getElementById("last-updated");

        try {
          // Запрос к RSSHub через CORS-прокси (используем corsproxy.io для GitHub Pages)
          const proxy = "https://corsproxy.io/?";
          const rssUrl = "https://rsshub.app/telegram/channel/hzdr25";
          const response = await fetch(proxy + encodeURIComponent(rssUrl));

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const text = await response.text();
          const parser = new DOMParser();
          const xml = parser.parseFromString(text, "text/xml");

          const items = xml.querySelectorAll("item");
          if (items.length === 0) throw new Error("Нет постов");

          const latest = items[0];
          const title =
            latest.querySelector("title")?.textContent || "Без заголовка";
          const description =
            latest.querySelector("description")?.textContent || "";
          const pubDate = latest.querySelector("pubDate")?.textContent || "";
          const link = latest.querySelector("link")?.textContent || "#";

          // Чистим HTML из описания Telegram (может быть много мусора)
          const cleanDesc =
            description
              .replace(/<br\s*\/?>/gi, "\n")
              .replace(/<\/?[^>]+(>|$)/g, "") // удаляем все HTML-теги
              .substring(0, 300) + (description.length > 300 ? "…" : "");

          const date = new Date(pubDate);
          const formattedDate = date.toLocaleString("ru-RU", {
            day: "numeric",
            month: "long",
            year: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });

          container.innerHTML = `
        <h3 style="color: white; margin-bottom: 10px;">${this.escapeHtml(
          title
        )}</h3>
        <p style="color: var(--text-secondary); white-space: pre-wrap;">${this.escapeHtml(
          cleanDesc
        )}</p>
        <p style="font-size: 0.9rem; color: #777; margin-top: 12px;">
          Опубликовано: ${formattedDate}
        </p>
        <a href="${link}" target="_blank" class="neon-button" style="margin-top: 12px; display: inline-block; font-size: 0.95rem; padding: 8px 20px;">
          Открыть в Telegram
        </a>
      `;

          timeEl.textContent = `Обновлено: ${new Date().toLocaleString(
            "ru-RU"
          )}`;
        } catch (err) {
          console.error("Ошибка загрузки поста:", err);
          container.innerHTML = `<p style="color: var(--neon-red);">⚠️ Не удалось загрузить пост.<br><small>${err.message}</small></p>`;
        }
      };

      // Утилита для экранирования HTML (на случай спецсимволов)
      updateLatestPost.escapeHtml = (str) => {
        const div = document.createElement("div");
        div.textContent = str;
        return div.innerHTML;
      };

      // Загружаем при старте
      updateLatestPost();

      // Обновляем каждые 12 часов: в 03:00 и 15:00 МСК
      const scheduleNextUpdate = () => {
        const now = new Date();
        const next3 = new Date(now);
        next3.setHours(3, 0, 0, 0);
        const next15 = new Date(now);
        next15.setHours(15, 0, 0, 0);

        let nextUpdate =
          now < next3
            ? next3
            : now < next15
            ? next15
            : next3.setDate(next3.getDate() + 1);

        if (nextUpdate <= now) {
          nextUpdate =
            next15 > now ? next15 : next3.setDate(next3.getDate() + 1);
        }

        const delay = nextUpdate - now;
        console.log(
          `Следующее обновление: ${new Date(nextUpdate).toLocaleString()}`
        );

        setTimeout(() => {
          updateLatestPost();
          scheduleNextUpdate(); // рекурсивно ставим следующее
        }, delay);
      };

      // Запускаем планировщик
      scheduleNextUpdate();
    </script>
  </body>
</html>

